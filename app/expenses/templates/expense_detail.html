{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <div class="card shadow-sm rounded-4 border-0">
    <div class="card-body">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
          <h3 class="fw-bold text-success mb-1">üí∏ Chi ti·∫øt chi ti√™u</h3>
          <small class="text-muted">Chi ti·∫øt v√† ph√¢n chia kho·∫£n chi</small>
        </div>
      </div>

      <!-- Payer -->
      <div class="mb-4">
        <h6 class="text-muted mb-1">Ai ƒë√£ tr·∫£ ti·ªÅn:</h6>
        <div class="d-flex align-items-center">
          <i class="bi bi-person-circle fs-3 text-success me-2"></i>
          <p class="fw-bold mb-0 text-dark">{{ expense.payer.username }}</p>
        </div>
      </div>

      <!-- Amount + currency convert -->
      <div class="text-center mb-4">
        <div class="card shadow-sm border-0 rounded-4 p-3 d-inline-block" style="min-width:320px;">
          <div class="mb-2 text-muted">S·ªë ti·ªÅn</div>
          <h1 class="display-5 text-danger fw-bold mb-2" id="amountDisplay"
              data-base-vnd="{{ expense.base_amount_vnd }}">
            {{ "{:,.0f}".format(expense.amount).replace(",", ".") }} {{ expense.currency }}
          </h1>

          <div class="d-flex justify-content-center align-items-center gap-3">
            <label for="currencySelect" class="mb-0 text-muted">ƒê·ªïi sang:</label>
            <select id="currencySelect" class="form-select" style="width: 160px;">
              <option value="VND">VND</option>
              <option value="USD">USD</option>
              <option value="EUR">EUR</option>
              <option value="JPY">JPY</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Shares -->
      <div class="mb-4">
        <h6 class="text-muted mb-2">D√†nh cho ai</h6>
        <div class="list-group rounded-4 shadow-sm overflow-hidden">
          {% for share in expense.shares %}
            <div class="list-group-item d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-center">
                <i class="bi bi-person-circle fs-5 text-success me-2"></i>
                <div>
                  <div class="fw-semibold">{{ share.user.username }}</div>
                  {% if share.share_percent %}
                    <small class="text-muted">({{ share.share_percent }}%)</small>
                  {% endif %}
                </div>
              </div>
              <div class="fw-bold text-danger">
                {{ "{:,.0f}".format(share.share_amount).replace(",", ".") }} ‚Ç´
              </div>
            </div>
          {% endfor %}
        </div>
      </div>

      <!-- Note + meta -->
      <div class="mb-3">
        <h6 class="text-muted">M·ª•c ƒë√≠ch</h6>
        <p class="mb-2">{{ expense.note or "Kh√¥ng c√≥ ghi ch√∫" }}</p>

        <div class="text-muted small">
          Ng√†y t·∫°o: {{ expense.date.strftime("%d/%m/%Y, %H:%M:%S") }}
        </div>
      </div>

      <!-- Footer actions -->
      <div class="text-end mt-4">
        <a href="{{ url_for('expenses.expense_list', group_id=expense.group_id) }}"
           class="btn btn-outline-secondary me-2">‚Üê Quay l·∫°i</a>
        <!-- gi·ªØ l·∫°i n√∫t ho·∫∑c h√†nh ƒë·ªông kh√°c n·∫øu c·∫ßn (kh√¥ng thay ƒë·ªïi) -->
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap icons (n·∫øu base.html ch∆∞a include) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">


<!-- ===== Currency conversion (gi·ªØ nguy√™n endpoint /expenses/get_rate/<currency>) ===== -->
<script>
async function fetchRateTo(currency){
  if (currency === 'VND') return 1;
  try {
    const res = await fetch(`/expenses/get_rate/${currency}`);
    if (!res.ok) return 1;
    const j = await res.json();
    return j.rate || 1;
  } catch (e) {
    console.error("L·ªói l·∫•y t·ª∑ gi√°:", e);
    return 1;
  }
}

document.addEventListener("DOMContentLoaded", function() {
  const sel = document.getElementById('currencySelect');
  const amountEl = document.getElementById('amountDisplay');
  if (!sel || !amountEl) return;

  sel.addEventListener('change', async function() {
    const target = this.value;
    // dataset.baseVnd v√¨ attribute l√† data-base-vnd
    const baseVnd = parseFloat(amountEl.dataset.baseVnd || amountEl.dataset.baseVnd);
    if (isNaN(baseVnd)) {
      console.warn("Gi√° tr·ªã base VND kh√¥ng h·ª£p l·ªá:", amountEl.dataset.baseVnd);
      return;
    }

    const rate = await fetchRateTo(target);
    // N·∫øu rate tr·∫£ v·ªÅ l√† t·ª∑ gi√° 1 target = X VND => VND -> target = baseVnd / rate
    const converted = Math.round(baseVnd / rate);
    // Format theo locale vi (vi-VN) r·ªìi thay d·∫•u ph·∫©y b·∫±ng d·∫•u ch·∫•m cho ph√π h·ª£p
    const formatted = converted.toLocaleString('vi-VN').replace(/,/g, '.');
    amountEl.innerText = formatted + ' ' + target;
  });
});
</script>
{% endblock %}
