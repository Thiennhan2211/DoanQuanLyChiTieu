{% extends "base.html" %}
{% block content %}
<div class="container-fluid mt-4">
  <div class="row g-4">

    <!-- C·ªòT TR√ÅI: CHI TI√äU -->
    <div class="col-lg-9 col-md-8">

      <!-- Ti√™u ƒë·ªÅ v√† n√∫t h√†nh ƒë·ªông -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold text-success">
          üí∏ Chi ti√™u trong nh√≥m: <span class="text-dark">{{ group.name }}</span>
        </h2>
        <div>
          <a href="{{ url_for('expenses.expense_new', group_id=group.id) }}" class="btn btn-success shadow-sm rounded-3 me-2">
            ‚ûï Th√™m chi ti√™u
          </a>
          <a href="{{ url_for('expenses.export_expenses', group_id=group.id) }}" class="btn btn-outline-success shadow-sm rounded-3">
            ‚¨áÔ∏è Xu·∫•t Excel
          </a>
        </div>
      </div>

      <!-- B·ªô l·ªçc -->
      <form method="get" class="row g-2 mb-4 bg-light p-3 rounded-4 shadow-sm">
        <div class="col-md-3">
          <input type="date" name="from" class="form-control rounded-3" placeholder="T·ª´ ng√†y">
        </div>
        <div class="col-md-3">
          <input type="date" name="to" class="form-control rounded-3" placeholder="ƒê·∫øn ng√†y">
        </div>
        <div class="col-md-3">
          <select name="user_id" class="form-select rounded-3">
            <option value="">-- Ng∆∞·ªùi tr·∫£ --</option>
            {% for u in group.members %}
              <option value="{{ u.id }}">{{ u.username }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2">
          <button class="btn btn-success w-100 shadow-sm rounded-3">L·ªçc</button>
        </div>
      </form>

      <!-- B·∫£ng chi ti√™u -->
      <div class="card shadow-sm border-0 rounded-4">
        <div class="card-body">
          <table class="table align-middle table-hover text-center">
            <thead class="table-success">
              <tr>
                <th>T√™n chi ti√™u</th>
                <th>S·ªë ti·ªÅn</th>
                <th>Ng√†y t·∫°o</th>
                <th>Ghi ch√∫</th>
                <th>Ng∆∞·ªùi th√™m</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              {% set grouped = {} %}
              {% for e in expenses %}
                {% set key = e.category.name if e.category else 'Kh√¥ng ph√¢n lo·∫°i' %}
                {% if key not in grouped %}
                  {% set _ = grouped.update({key: []}) %}
                {% endif %}
                {% set _ = grouped[key].append(e) %}
              {% endfor %}

              {% for category_name, items in grouped.items() %}
              <tr class="table-light fw-bold">
                <td colspan="6" class="text-start py-2">
                  {% if items[0].category and items[0].category.icon %}
                    {{ items[0].category.icon }}
                  {% else %}
                    üìå
                  {% endif %}
                  {{ category_name }}
                </td>
              </tr>

              {% for expense in items %}
              <tr>
                <td class="text-start">{{ expense.title }}</td>
                <td class="text-danger fw-semibold">{{ expense.amount_formatted }}</td>
                <td>{{ expense.date.strftime('%d/%m/%Y') }}</td>
                <td>{{ expense.note or '-' }}</td>
                <td><i class="bi bi-person-circle text-success"></i> {{ expense.payer.username }}</td>
                <td>
                  <a href="{{ url_for('expenses.expense_detail', expense_id=expense.id) }}" 
                     class="btn btn-sm btn-outline-success rounded-3 shadow-sm">
                    üîç Chi ti·∫øt
                  </a>
                  <form action="{{ url_for('expenses.delete_expense', expense_id=expense.id) }}" 
                        method="POST" style="display:inline;">
                    <button type="submit" 
                            class="btn btn-sm btn-outline-danger rounded-3 shadow-sm"
                            onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a chi ti√™u n√†y?');">
                      üóë X√≥a
                    </button>
                  </form>
                </td>
              </tr>
              {% endfor %}
              {% else %}
              <tr><td colspan="6" class="text-center text-muted py-3">Ch∆∞a c√≥ chi ti√™u n√†o.</td></tr>
              {% endfor %}
            </tbody>
          </table>

          <div class="text-end mt-3">
            <h5 class="fw-bold">
              T·ªïng chi ti√™u:
              <span class="text-danger">
                {{ "{:,.0f}".format(total).replace(",", ".") }} ‚Ç´
              </span>
            </h5>
          </div>
        </div>
      </div>

      <!-- DANH S√ÅCH N·ª¢ -->
      {% if debt_suggestions %}
<div class="card shadow-sm rounded-4 mt-4 border-0 no-hover">
  <div class="card-header bg-warning bg-opacity-25 fw-bold text-dark border-0">
    üí∞ N·ª£ n·∫ßn gi·ªØa c√°c th√†nh vi√™n
  </div>
  <div class="card-body">
    {% for d in debt_suggestions %}
    <div class="d-flex justify-content-between align-items-center border-bottom py-3">
            <div class="d-flex align-items-center">
              <img src="{{ url_for('static', filename='images/default-avatar.png') }}" 
                   class="rounded-circle me-2 border border-success border-2" width="42" height="42">
              <div>
                <strong>{{ d.from.username }}</strong><br>
                <span class="text-danger fw-semibold">
                  -{{ "{:,.0f}".format(d.amount).replace(",", ".") }} ‚Ç´
                </span>
              </div>
            </div>

            <div class="text-center flex-grow-1">
              <i class="bi bi-arrow-right fs-4 text-secondary"></i>
            </div>

            <div class="d-flex align-items-center">
              <div class="text-end me-2">
                <strong>{{ d.to.username }}</strong>
              </div>
              <img src="{{ url_for('static', filename='images/default-avatar.png') }}" 
                   class="rounded-circle border border-success border-2" width="42" height="42">
            </div>

            {% if current_user.id == d.from.id %}
              <span class="text-muted small ms-2">(Kh√¥ng th·ªÉ nh·∫Øc ch√≠nh m√¨nh)</span>
            {% elif current_user.id == d.to.id %}
              <form method="POST" action="{{ url_for('expenses.remind_payment', to_user_id=d.from.id) }}" class="ms-3">
        <button type="button" class="btn btn-outline-success btn-sm rounded-3 shadow-sm no-hover-btn" 
                data-bs-toggle="modal" data-bs-target="#paymentModal{{ d.from.id }}">
          üí≥ Nh·∫Øc thanh to√°n
        </button>

                <!-- Modal -->
                <div class="modal fade" id="paymentModal{{ d.from.id }}" tabindex="-1" aria-labelledby="paymentModalLabel{{ d.from.id }}" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content rounded-4">
                      <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">Nh·∫Øc {{ d.from.username }} thanh to√°n</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        <div class="mb-3">
                          <label class="form-label">Ng√¢n h√†ng</label>
                          <input type="text" name="bank_name" class="form-control rounded-3" placeholder="Nh·∫≠p t√™n ng√¢n h√†ng" required>
                        </div>
                        <div class="mb-3">
                          <label class="form-label">S·ªë t√†i kho·∫£n</label>
                          <input type="text" name="bank_account" class="form-control rounded-3" placeholder="Nh·∫≠p s·ªë t√†i kho·∫£n" required>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="submit" class="btn btn-success rounded-3">G·ª≠i nh·∫Øc</button>
                        <button type="button" class="btn btn-secondary rounded-3" data-bs-dismiss="modal">H·ªßy</button>
                      </div>
                    </div>
                  </div>
                </div>
              </form>
            {% endif %}

            {% if current_user.id == d.to.id or current_user.id == d.from.id %}
              <form method="POST" action="{{ url_for('expenses.settle_debt', from_user_id=d.from.id, to_user_id=d.to.id, group_id=group.id) }}" class="ms-2">
                <button type="submit" class="btn btn-outline-primary btn-sm rounded-3 shadow-sm"
                        onclick="return confirm('X√°c nh·∫≠n {{ d.from.username }} ƒë√£ thanh to√°n?');">
                  ‚úÖ ƒê√£ thanh to√°n
                </button>
              </form>
            {% endif %}
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <div class="text-center mt-4">
        <a href="{{ url_for('groups.group_list') }}" class="btn btn-outline-secondary rounded-3 shadow-sm">
          ‚Üê Quay l·∫°i danh s√°ch nh√≥m
        </a>
      </div>

    </div>

    <!-- C·ªòT PH·∫¢I: TH√ÄNH VI√äN -->
    <div class="col-lg-3 col-md-4">
      <div class="card shadow-sm border-0 rounded-4 sticky-top" style="top: 90px;">
        <div class="card-header bg-success text-white text-center fw-bold rounded-top-4">
          üë• Th√†nh vi√™n nh√≥m
        </div>
        <div class="card-body p-3">
          {% if group.members %}
            {% for member in group.members %}
              <div class="d-flex align-items-center justify-content-between mb-3 border-bottom pb-2">
                <div class="d-flex align-items-center">
                  <img src="{{ url_for('static', filename='images/default-avatar.png') }}" alt="avatar"
                       class="rounded-circle me-2 border border-success border-2" width="42" height="42">
                  <div>
                    <strong>
                      {% if member.id == current_user.id %}
                        {{ member.username }} <span class="text-success">(B·∫°n)</span>
                      {% else %}
                        {{ member.username }}
                      {% endif %}
                    </strong><br>
                    <small class="text-muted">
                      ƒê√£ chi: {{ "{:,.0f}".format(member_balances[member.id].paid).replace(",", ".") }} ‚Ç´
                    </small><br>
                    {% set bal = member_balances[member.id].balance %}
                    {% if bal > 0 %}
                      <span class="text-success fw-semibold">+{{ "{:,.0f}".format(bal).replace(",", ".") }} ‚Ç´</span>
                    {% elif bal < 0 %}
                      <span class="text-danger fw-semibold">-{{ "{:,.0f}".format(-bal).replace(",", ".") }} ‚Ç´</span>
                    {% else %}
                      <span class="text-secondary">0 ‚Ç´</span>
                    {% endif %}
                  </div>
                </div>
                {% if current_user.id == group.creator_id and member.id != group.creator_id %}
                  <form method="POST" action="{{ url_for('groups.remove_member', group_id=group.id, user_id=member.id) }}" 
                        onsubmit="return confirm('X√≥a {{ member.username }} kh·ªèi nh√≥m?');">
                    <button class="btn btn-sm btn-outline-danger rounded-circle">‚ùå</button>
                  </form>
                {% endif %}
              </div>
            {% endfor %}
          {% else %}
            <p class="text-muted text-center mb-0">Ch∆∞a c√≥ th√†nh vi√™n n√†o</p>
          {% endif %}
        </div>
        <div class="card-footer bg-light rounded-bottom-4">
          <form method="POST" action="{{ url_for('groups.add_member', group_id=group.id) }}" class="d-flex">
            <input type="email" name="email" class="form-control me-2 rounded-3" placeholder="Nh·∫≠p email m·ªùi v√†o nh√≥m" required>
            <button class="btn btn-success rounded-3">+</button>
          </form>
        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}
